<!DOCTYPE html>
<html lang="<%= currentLanguage %>">
<head>
  <%- include('partials/head') %>
  <title>VILNIUS TECH | <%= t('dashboard.title') %></title>
</head>
<body>
  <div class="dash collapsed">
    <!-- Sidebar -->
    <%- include('partials/sidebar') %>

    <!-- Main -->
    <main class="main">
      <!-- Topbar -->
      <%- include('partials/header') %>

      <!-- Content grid -->
      <section class="grid">
        <% const dashboardEventsSource = typeof upcomingEvents !== 'undefined' ? upcomingEvents : []; %>
        <% const dashboardEvents = Array.isArray(dashboardEventsSource) ? dashboardEventsSource : []; %>
        <% const dashboardPastEventsSource = typeof pastEvents !== 'undefined' ? pastEvents : []; %>
        <% const dashboardPastEvents = Array.isArray(dashboardPastEventsSource) ? dashboardPastEventsSource : []; %>
        <% const todayTomorrowSource = typeof todayTomorrowSchedule !== 'undefined' ? todayTomorrowSchedule : []; %>
        <% const todayTomorrowLessons = Array.isArray(todayTomorrowSource) ? todayTomorrowSource : []; %>
        <% const weeklyScheduleSource = typeof weeklyScheduleByDay !== 'undefined' ? weeklyScheduleByDay : []; %>
        <% const weeklySchedule = Array.isArray(weeklyScheduleSource) ? weeklyScheduleSource : []; %>
        <% const weeklyScheduleWeekdays = weeklySchedule.filter((dayBlock) => Number(dayBlock.dayOfWeek) >= 1 && Number(dayBlock.dayOfWeek) <= 5); %>
        <% const allSchedulesSource = typeof allSchedulesByDay !== 'undefined' ? allSchedulesByDay : weeklySchedule; %>
        <% const allSchedulesByWeekday = Array.isArray(allSchedulesSource)
          ? allSchedulesSource.filter((dayBlock) => Number(dayBlock.dayOfWeek) >= 1 && Number(dayBlock.dayOfWeek) <= 5)
          : []; %>
        <% const allScheduleEntriesSource = typeof allScheduleEntries !== 'undefined' ? allScheduleEntries : []; %>
        <% const adminScheduleEntries = Array.isArray(allScheduleEntriesSource) ? allScheduleEntriesSource : []; %>
        <% const scheduleGroupsSource = typeof scheduleGroups !== 'undefined' ? scheduleGroups : []; %>
        <% const scheduleGroupsList = Array.isArray(scheduleGroupsSource) ? scheduleGroupsSource : []; %>
        <% const scheduleDayLabels = {
          1: t('schedules.days.monday'),
          2: t('schedules.days.tuesday'),
          3: t('schedules.days.wednesday'),
          4: t('schedules.days.thursday'),
          5: t('schedules.days.friday'),
          6: t('schedules.days.saturday'),
          7: t('schedules.days.sunday')
        }; %>
        <div class="dashboard-main-column">
          <% if (user.role !== 'admin') { %>
            <article class="card" id="my-schedule">
              <div class="card-head">
                <h2><%= t('schedules.mySchedule') %></h2>
              </div>

              <% if (todayTomorrowLessons.length > 0) { %>
                <ul class="list schedule-list">
                  <% todayTomorrowLessons.forEach((lesson) => { %>
                    <% const isToday = Number(todayDay) === Number(lesson.day_of_week); %>
                    <% const isTomorrow = Number(tomorrowDay) === Number(lesson.day_of_week); %>
                    <li class="list-item schedule-list-item">
                      <div class="date">
                        <strong><%= scheduleDayLabels[lesson.day_of_week] || '-' %></strong><br>
                        <small><%= lesson.start_time %> - <%= lesson.end_time %></small>
                      </div>
                      <div class="txt">
                        <strong><%= lesson.subject %></strong>
                        <small class="muted">
                          <% if (isToday) { %>
                            <%= t('schedules.today') %>
                          <% } else if (isTomorrow) { %>
                            <%= t('schedules.tomorrow') %>
                          <% } else { %>
                            <%= scheduleDayLabels[lesson.day_of_week] || '' %>
                          <% } %>
                          <% if (lesson.classroom) { %> • <%= lesson.classroom %><% } %>
                          <% if (lesson.lecture_type) { %> • <%= lesson.lecture_type %><% } %>
                        </small>
                        <% if (lesson.lecturer) { %>
                          <small class="muted"><%= lesson.lecturer %></small>
                        <% } %>
                      </div>
                    </li>
                  <% }); %>
                </ul>
              <% } else { %>
                <p class="muted event-empty"><%= t('schedules.noneTodayTomorrow') %></p>
              <% } %>

              <div class="schedule-actions">
                <button type="button" class="btn ghost all-schedules-btn" id="openAllSchedulesBtn"><%= t('schedules.allSchedules') %></button>
              </div>
            </article>
          <% } %>

          <% if(user.role === 'admin') { %>
            <article class="card" id="manage-schedules">
              <div class="card-head">
                <h2><%= t('schedules.manageTitle') %></h2>
                <span class="badge"><%= t('dashboard.admin') %></span>
              </div>

              <form action="/schedules/admin" method="POST" class="profile-change-form event-manage-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="return_to" value="/dashboard#manage-schedules">

                <select name="group_name" class="profile-change-input" required>
                  <option value=""><%= t('schedules.groupPlaceholder') %></option>
                  <% scheduleGroupsList.forEach((item) => { %>
                    <% if (item.group_name) { %>
                      <option value="<%= item.group_name %>"><%= item.group_name %></option>
                    <% } %>
                  <% }); %>
                </select>

                <select name="day_of_week" class="profile-change-input" required>
                  <option value=""><%= t('schedules.dayPlaceholder') %></option>
                  <option value="1"><%= t('schedules.days.monday') %></option>
                  <option value="2"><%= t('schedules.days.tuesday') %></option>
                  <option value="3"><%= t('schedules.days.wednesday') %></option>
                  <option value="4"><%= t('schedules.days.thursday') %></option>
                  <option value="5"><%= t('schedules.days.friday') %></option>
                </select>

                <select name="lecture_slot" class="profile-change-input" required>
                  <option value=""><%= t('schedules.slotPlaceholder') %></option>
                  <option value="1"><%= t('schedules.slots.slot1') %></option>
                  <option value="2"><%= t('schedules.slots.slot2') %></option>
                  <option value="3"><%= t('schedules.slots.slot3') %></option>
                  <option value="4"><%= t('schedules.slots.slot4') %></option>
                  <option value="5"><%= t('schedules.slots.slot5') %></option>
                  <option value="6"><%= t('schedules.slots.slot6') %></option>
                  <option value="7"><%= t('schedules.slots.slot7') %></option>
                </select>

                <input
                  type="text"
                  name="subject"
                  class="profile-change-input"
                  placeholder="<%= t('schedules.subjectPlaceholder') %>"
                  required
                  maxlength="160"
                >
                <input
                  type="text"
                  name="classroom"
                  class="profile-change-input"
                  placeholder="<%= t('schedules.classroomPlaceholder') %>"
                  maxlength="80"
                >
                <input
                  type="text"
                  name="lecturer"
                  class="profile-change-input"
                  placeholder="<%= t('schedules.lecturerPlaceholder') %>"
                  maxlength="120"
                >
                <input
                  type="text"
                  name="lecture_type"
                  class="profile-change-input"
                  placeholder="<%= t('schedules.typePlaceholder') %>"
                  maxlength="80"
                >

                <select name="week_pattern" class="profile-change-input" required>
                  <option value="all"><%= t('schedules.weekPattern.all') %></option>
                  <option value="week1"><%= t('schedules.weekPattern.week1') %></option>
                  <option value="week2"><%= t('schedules.weekPattern.week2') %></option>
                </select>

                <button type="submit" class="btn profile-change-submit"><%= t('schedules.addButton') %></button>
              </form>

              <div class="event-manage-list-wrap">
                <a href="/schedules/admin" class="btn ghost"><%= t('schedules.fullSystemButton') %></a>
              </div>
            </article>

            <article class="card" id="manage-events">
              <div class="card-head">
                <h2><%= t('events.manageTitle') %></h2>
                <span class="badge"><%= t('dashboard.admin') %></span>
              </div>

              <form action="/events/admin" method="POST" class="profile-change-form event-manage-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input
                  type="text"
                  name="title"
                  class="profile-change-input"
                  placeholder="<%= t('events.titlePlaceholder') %>"
                  required
                  maxlength="140"
                >
                <textarea
                  name="details"
                  class="profile-change-input"
                  placeholder="<%= t('events.detailsPlaceholder') %>"
                  rows="3"
                  maxlength="1200"
                ></textarea>
                <input
                  type="datetime-local"
                  name="starts_at"
                  class="profile-change-input"
                  required
                >
                <button type="submit" class="btn profile-change-submit"><%= t('events.addButton') %></button>
              </form>

              <div class="event-manage-list-wrap">
                <h3 class="profile-change-title"><%= t('events.existingEvents') %></h3>
                <% if (dashboardEvents.length > 0) { %>
                  <ul class="list events-list admin-events-list">
                    <% dashboardEvents.forEach((eventItem) => { %>
                      <% const eventDate = new Date(Number(eventItem.starts_at)); %>
                      <% const dateLabel = Number.isNaN(eventDate.getTime())
                        ? '-'
                        : eventDate.toLocaleDateString(currentLanguage, { year: 'numeric', month: '2-digit', day: '2-digit' }); %>
                      <% const timeLabel = Number.isNaN(eventDate.getTime())
                        ? ''
                        : eventDate.toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' }); %>
                      <li class="list-item event-list-item">
                        <div class="date"><%= dateLabel %><br><small><%= timeLabel %></small></div>
                        <div class="txt">
                          <strong><%= eventItem.title %></strong>
                          <% if (eventItem.details) { %>
                            <small class="muted"><%= eventItem.details %></small>
                          <% } %>
                        </div>
                        <form action="/events/admin/<%= eventItem.id %>/delete" method="POST" class="event-delete-form">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <button type="submit" class="btn small danger"><%= t('events.removeButton') %></button>
                        </form>
                      </li>
                    <% }); %>
                  </ul>
                <% } else { %>
                  <p class="muted event-empty"><%= t('events.noUpcoming') %></p>
                <% } %>
              </div>
            </article>

            <article class="card">
              <div class="card-head">
                <h2><%= t('dashboard.sendNotification') %></h2>
                <span class="badge"><%= t('dashboard.admin') %></span>
              </div>
              <form action="/notifications/admin/broadcast" method="POST" class="profile-change-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input
                  type="text"
                  name="title"
                  class="profile-change-input"
                  placeholder="<%= t('dashboard.notificationTitle') %>"
                  required
                  maxlength="120"
                >
                <textarea
                  name="message"
                  class="profile-change-input"
                  placeholder="<%= t('dashboard.notificationMessage') %>"
                  rows="4"
                  required
                  maxlength="1200"
                ></textarea>
                <button type="submit" class="btn profile-change-submit"><%= t('dashboard.sendAll') %></button>
              </form>
            </article>
          <% } %>

          <% if(success_msg && success_msg.length > 0){ %>
              <div class="alert alert-success">
                  <%= success_msg %>
              </div>
          <% } %>
          <% if(error_msg && error_msg.length > 0){ %>
              <div class="alert alert-danger">
                  <%= error_msg %>
              </div>
          <% } %>
        </div>

        <%- include('partials/upcoming-events', { upcomingEvents: dashboardEvents, pastEvents: dashboardPastEvents, currentLanguage, t }) %>

        <article class="card all-schedules-center-card" id="allSchedulesCard" hidden>
          <div class="card-head">
            <h2><%= t('schedules.allSchedules') %></h2>
            <button type="button" class="btn ghost small" id="closeAllSchedulesBtn"><%= t('events.closeButton') %></button>
          </div>

          <div class="all-schedules-sections">
            <% if (allSchedulesByWeekday.length > 0) { %>
              <% allSchedulesByWeekday.forEach((dayBlock) => { %>
                <section class="schedule-day-block">
                  <h3 class="profile-change-title"><%= scheduleDayLabels[dayBlock.dayOfWeek] || '-' %></h3>

                  <% if (Array.isArray(dayBlock.lessons) && dayBlock.lessons.length > 0) { %>
                    <ul class="list events-list">
                      <% dayBlock.lessons.forEach((lesson) => { %>
                        <li class="list-item event-list-item">
                          <div class="date"><%= lesson.start_time %><br><small><%= lesson.end_time %></small></div>
                          <div class="txt">
                            <strong><%= lesson.subject %></strong>
                            <small class="muted">
                              <%= t(`schedules.weekPattern.${lesson.week_pattern || 'all'}`) %>
                              <% if (lesson.classroom) { %> • <%= lesson.classroom %><% } %>
                              <% if (lesson.lecture_type) { %> • <%= lesson.lecture_type %><% } %>
                            </small>
                            <% if (lesson.lecturer) { %>
                              <small class="muted"><%= lesson.lecturer %></small>
                            <% } %>
                          </div>
                        </li>
                      <% }); %>
                    </ul>
                  <% } else { %>
                    <p class="muted event-empty"><%= t('schedules.noLessonsDay') %></p>
                  <% } %>
                </section>
              <% }); %>
            <% } else { %>
              <p class="muted event-empty"><%= t('schedules.noneWeekly') %></p>
            <% } %>
          </div>
        </article>

        <div id="allSchedulesBackdrop" hidden aria-hidden="true"></div>

        <article class="card all-events-center-card" id="allEventsCard" hidden>
          <div class="card-head">
            <h2><%= t('events.allEventsTitle') %></h2>
            <button type="button" class="btn ghost small" id="closeAllEventsBtn"><%= t('events.closeButton') %></button>
          </div>

          <div class="all-events-sections">
            <section>
              <h3 class="profile-change-title"><%= t('events.upcomingTitle') %></h3>
              <% if (dashboardEvents.length > 0) { %>
                <ul class="list events-list">
                  <% dashboardEvents.forEach((eventItem) => { %>
                    <% const eventDate = new Date(Number(eventItem.starts_at)); %>
                    <% const dateLabel = Number.isNaN(eventDate.getTime())
                      ? '-'
                      : eventDate.toLocaleDateString(currentLanguage, { year: 'numeric', month: '2-digit', day: '2-digit' }); %>
                    <% const timeLabel = Number.isNaN(eventDate.getTime())
                      ? ''
                      : eventDate.toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' }); %>
                    <li class="list-item event-list-item">
                      <div class="date"><%= dateLabel %><br><small><%= timeLabel %></small></div>
                      <div class="txt">
                        <strong><%= eventItem.title %></strong>
                        <% if (eventItem.details) { %>
                          <small class="muted"><%= eventItem.details %></small>
                        <% } %>
                      </div>
                    </li>
                  <% }); %>
                </ul>
              <% } else { %>
                <p class="muted event-empty"><%= t('events.noUpcoming') %></p>
              <% } %>
            </section>

            <section>
              <h3 class="profile-change-title"><%= t('events.pastTitle') %></h3>
              <% if (dashboardPastEvents.length > 0) { %>
                <ul class="list events-list">
                  <% dashboardPastEvents.forEach((eventItem) => { %>
                    <% const eventDate = new Date(Number(eventItem.starts_at)); %>
                    <% const dateLabel = Number.isNaN(eventDate.getTime())
                      ? '-'
                      : eventDate.toLocaleDateString(currentLanguage, { year: 'numeric', month: '2-digit', day: '2-digit' }); %>
                    <% const timeLabel = Number.isNaN(eventDate.getTime())
                      ? ''
                      : eventDate.toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' }); %>
                    <li class="list-item event-list-item">
                      <div class="date"><%= dateLabel %><br><small><%= timeLabel %></small></div>
                      <div class="txt">
                        <strong><%= eventItem.title %></strong>
                        <% if (eventItem.details) { %>
                          <small class="muted"><%= eventItem.details %></small>
                        <% } %>
                      </div>
                    </li>
                  <% }); %>
                </ul>
              <% } else { %>
                <p class="muted event-empty"><%= t('events.noPast') %></p>
              <% } %>
            </section>
          </div>
        </article>

        <div id="allEventsBackdrop" hidden aria-hidden="true"></div>

      </section>

      <%- include('partials/footer') %>
    </main>
  </div>
</body>
</html>
